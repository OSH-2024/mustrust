# 性能测试与分析
## 测试任务选定
随着 AI 的发展，深度学习也逐渐融入了我们的日常生活中，而模型的推理也成为了 AI 融入生活时必不可少的一部分。

我们使用 MNIST 数据集进行了最简单的手写数字识别训练，神经网络模型的结构如下：
+ 输入层：大小为 784，即一张 28*28 图片的大小；
+ 第一层隐含层：大小为 448，即 28*16；
+ 第二层隐含层：大小为 160，即 16*10；
+ 输出层：大小为 10，即每一种数字的概率。

每两层之间均为全连接层，即参数的数量达到了 425130 个。

现在训练已经完成，下面需要使用大小为 100000 的测试数据集，在该神经网络上进行测试，并得到 100000 个长度为 10 的输出结果向量。

我们对这个过程进行简化，本次的实验内容为测试效率，模型的参数以及数据集中的具体数据不重要，我们使用随机的参数和随机的数据集进行测试。

## 测试性能指标
+ 吞吐率：系统在单位时间内能够处理的任务数量；
+ 延迟：单任务从提交至系统到处理完成所耗费的时间；
+ 资源使用率：系统运行任务时 CPU、GPU、内存等硬件的占用率；
+ IO 使用率：系统运行任务时 IO 和网络的吞吐率；
+ 稳定性：系统执行任务的成功率。

在分布式计算中，吞吐率是最重要的性能指标，所以我们将其作为测试指标。由于本次任务为 CPU 密集型任务，CPU 使用率越高，说明任务的调度更加高效，执行效率也就更高。综上，我们将**吞吐率**和**CPU 使用率**作为测试指标。

单机测试所用的电脑为 12 核 CPU，内存 128GB，分布式测试加入了一台 16 核 CPU、内存 16GB 的电脑。

## 性能测试
### 单机部署
对未优化的程序进行测试，吞吐率如下：

| 测试编号 | 用时 / s | 吞吐率 / TPS |
| -------- | -------- | ------------ |
| 1        | 66.324   | 1507.750     |
| 2        | 64.185   | 1557.996     |
| 3        | 65.694   | 1522.209     |
| 4        | 66.445   | 1505.004     |
| 5        | 66.547   | 1502.697     |
| 平均     | 65.839   | 1519.131     |

选取其中一次测试，查看其 CPU 占用如下：

![image-20240625192612684](src/image-20240625192612684.png)

CPU 占用不到 30%，还存在非常大的优化空间。

### 单机优化

我们发现，由于只有一个神经网络类，所以只启动了一个 Actor，目前所有的任务都只发到了一个 Actor 上，所以我们将神经网络进一步包装为一个类 Actor，然后定义若干个这个类，这样就可以启动多个 Actor 进行并行，提高效率。

另外，我们每一次只提交一个任务，而这个任务大多数时候很快就被计算完了，此时大量的时间就会浪费在提交的过程中。所以，我们将多个任务分为一组提交，减少浪费在提交过程中的时间。

我们按照 10 个 Actor、每组 10 个任务进行测试，吞吐率如下：

| 测试编号 | 用时 / s | 吞吐率 / TPS |
| -------- | -------- | ------------ |
| 1        | 6.399    | 15627.44     |
| 2        | 7.021    | 14242.99     |
| 3        | 6.181    | 16178.61     |
| 4        | 6.436    | 15537.60     |
| 5        | 6.935    | 14419.61     |
| 平均     | 6.594    | 15201.25     |

由于上述测试中每次运行的时间很短，难以获得准确的 CPU 占用，我们将任务总量提升至 1000000，运行并测试 CPU 占用：

![image-20240625193519055](src/image-20240625193519055.png)

可以看到 CPU 占用达到甚至超过了 60%。

相比于优化之前，吞吐率提升了 900% 左右，CPU 占用提升了 200% 以上。
